# Home Assistant Add-on: HTML-to-Image (H2I)

This Home Assistant add-on runs the `bybetas/h2i` service, which provides a simple, local API to convert HTML into images. It's designed to be used by other services on your network, such as n8n, for generating dynamic images from HTML code.

## Installation

1.  Add this repository URL to your Home Assistant Supervisor Add-on Store:
    `https://github.com/guiman87/addon-h2i`
2.  Install the **HTML-to-Image (H2I)** add-on.
3.  In the add-on's **Configuration** tab, set a host port (e.g., `5005`) for the service.
4.  Configure the options as needed (quality, width, height, timeout).
5.  Start the add-on.

## Configuration

The add-on offers the following configuration options:

| Option               | Description                                    | Default |
|----------------------|------------------------------------------------|---------|
| quality              | JPEG image quality (1-100)                     | 80      |
| width                | Default image width in pixels                  | 800     |
| height               | Default image height in pixels                 | 600     |
| timeout              | Maximum time to wait for rendering (ms)        | 30000   |
| allow_external_access| Allow connections from outside Home Assistant  | true    |

## Usage

The add-on exposes an HTTP endpoint on the port you configure. You can send a `POST` request with a JSON body containing your HTML, and it will return a JPG image.

### Basic Usage

**Example `curl` command:**

```bash
curl -X POST \
  http://homeassistant.local:5005 \
  -H 'Content-Type: application/json' \
  -d '{"html": "<html><body><h1>Hello, World!</h1></body></html>"}' \
  --output my-image.jpg
```

### Advanced Options

You can override the default width, height, and quality when making a request:

```bash
curl -X POST \
  http://homeassistant.local:5005 \
  -H 'Content-Type: application/json' \
  -d '{
    "html": "<html><body><h1>Hello, World!</h1></body></html>",
    "width": 1200,
    "height": 800,
    "quality": 90
  }' \
  --output my-image.jpg
```

## Using with n8n

To use this addon with n8n:

1. Make sure both the H2I addon and n8n addon are running
2. In your n8n workflow, add an HTTP Request node
3. Configure the HTTP Request node as follows:
   - **Method**: POST
   - **URL**: `http://homeassistant.local:5005` (or use your Home Assistant IP address)
   - **Headers**: Add Content-Type: application/json
   - **Body**: JSON object with at least the "html" property
   - **Response Format**: File

Example n8n HTTP Request Body:
```json
{
  "html": "<html><body><h1>Generated by n8n</h1><p>This is a test</p></body></html>",
  "width": 1000,
  "height": 600
}
```

## Troubleshooting

### Connection Issues from n8n

If n8n reports "The connection to the server was closed unexpectedly":

1. **Check direct connectivity**: Try accessing the H2I service directly using curl from your Home Assistant host:
   ```bash
   curl -v http://localhost:5005
   ```

2. **Use the IP address instead of hostname**: In your n8n HTTP Request node, try using the direct IP address of your Home Assistant instance instead of the hostname:
   ```
   http://192.168.x.x:5005
   ```

3. **Check if the addon is running**: Verify in Home Assistant that the H2I addon shows as "Running" and check its logs for any errors.

4. **Test with simple HTML**: Start with very simple HTML to rule out rendering issues:
   ```json
   {"html": "<html><body><h1>Test</h1></body></html>"}
   ```

5. **Increase timeout values**: Both in the addon configuration and in your n8n HTTP Request node, try increasing timeout values.

6. **Check firewall settings**: Ensure your network allows connections between the n8n container and the H2I container.

### General Troubleshooting

1. Check that the port is correctly mapped and not blocked by firewalls
2. Verify that the HTML content is valid
3. Try increasing the timeout value if your HTML is complex
4. Check the addon logs for any error messages
5. Ensure that the H2I container has proper network access
6. Try restarting both n8n and H2I addons if you're experiencing connectivity issues
